import{Schema as ue,store as R,useContext as le,useRpc as te,valueMap as de,clone as me,deepEqual as pe,pick as X,send as b,icons as oe}from"@koishijs/client";import{openBlock as d,createElementBlock as x,createElementVNode as C,defineComponent as I,ref as y,computed as j,watch as se,resolveComponent as v,Fragment as q,unref as L,createBlock as $,withCtx as o,createTextVNode as _,createCommentVNode as B,createVNode as m,renderList as Y,normalizeClass as F,toDisplayString as z,withKeys as Z,withModifiers as ee,nextTick as ne,onActivated as _e,inject as ce}from"vue";import{useRoute as ve,useRouter as fe}from"vue-router";import{watchDebounced as Ce}from"@vueuse/core";const W=(a,c)=>{const i=a.__vccOpts||a;for(const[r,s]of c)i[r]=s;return i},ge={},he={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},ke=C("path",{fill:"currentColor",d:"M368 320H320V192h48C412.2 192 448 156.2 448 112C448 67.82 412.2 32 368 32S288 67.82 288 112V160H160V112C160 67.82 124.2 32 80 32S0 67.82 0 112C0 156.2 35.82 192 80 192H128v128H80C35.82 320 0 355.8 0 400C0 444.2 35.82 480 80 480S160 444.2 160 400V352h128v48c0 44.18 35.82 80 80 80s80-35.82 80-80C448 355.8 412.2 320 368 320zM320 112C320 85.53 341.5 64 368 64S416 85.53 416 112S394.5 160 368 160H320V112zM128 400C128 426.5 106.5 448 80 448S32 426.5 32 400S53.53 352 80 352H128V400zM128 160H80C53.53 160 32 138.5 32 112S53.53 64 80 64S128 85.53 128 112V160zM288 320H160V192h128V320zM368 448c-26.47 0-48-21.53-48-48V352h48c26.47 0 48 21.53 48 48S394.5 448 368 448z"},null,-1),ye=[ke];function Ve(a,c){return d(),x("svg",he,ye)}const we=W(ge,[["render",Ve]]),be={},$e={class:"k-icon check",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},xe=C("path",{fill:"currentColor",d:"M438.6 105.4C451.1 117.9 451.1 138.1 438.6 150.6L182.6 406.6C170.1 419.1 149.9 419.1 137.4 406.6L9.372 278.6C-3.124 266.1-3.124 245.9 9.372 233.4C21.87 220.9 42.13 220.9 54.63 233.4L159.1 338.7L393.4 105.4C405.9 92.88 426.1 92.88 438.6 105.4H438.6z"},null,-1),He=[xe];function Se(a,c){return d(),x("svg",$e,He)}const Me=W(be,[["render",Se]]),ze={},Le={class:"k-icon",xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 448 512"},Ee=C("path",{fill:"currentColor",d:"M160 400C160 408.8 152.8 416 144 416C135.2 416 128 408.8 128 400V192C128 183.2 135.2 176 144 176C152.8 176 160 183.2 160 192V400zM240 400C240 408.8 232.8 416 224 416C215.2 416 208 408.8 208 400V192C208 183.2 215.2 176 224 176C232.8 176 240 183.2 240 192V400zM320 400C320 408.8 312.8 416 304 416C295.2 416 288 408.8 288 400V192C288 183.2 295.2 176 304 176C312.8 176 320 183.2 320 192V400zM317.5 24.94L354.2 80H424C437.3 80 448 90.75 448 104C448 117.3 437.3 128 424 128H416V432C416 476.2 380.2 512 336 512H112C67.82 512 32 476.2 32 432V128H24C10.75 128 0 117.3 0 104C0 90.75 10.75 80 24 80H93.82L130.5 24.94C140.9 9.357 158.4 0 177.1 0H270.9C289.6 0 307.1 9.358 317.5 24.94H317.5zM151.5 80H296.5L277.5 51.56C276 49.34 273.5 48 270.9 48H177.1C174.5 48 171.1 49.34 170.5 51.56L151.5 80zM80 432C80 449.7 94.33 464 112 464H336C353.7 464 368 449.7 368 432V128H80V432z"},null,-1),De=[Ee];function Oe(a,c){return d(),x("svg",Le,De)}const je=W(ze,[["render",Oe]]);function ie(a,c){if(["intersect","union"].includes(a.type))for(const i of a.list)ie(i,c);else if(a.type==="object")for(const i in c)a.dict[i]&&(a.dict[i]=a.dict[i].default(c[i]))}function ae(a,c){const i=new ue(R.schema[a]);return c&&ie(i,c),i}const Ne={class:"navigation flex flex-wrap gap-x-4 gap-y-2 my-8"},Ue={class:"mb-8"},Ke={class:"k-schema-header"},Be={class:"text-left"},Te={class:"text-right"},Ae={class:"mt-2"},Re=I({__name:"command",props:{command:{}},setup(a){const c=le(),i=te(),r=a,s=y(),S=y(),f=y(""),g=y(""),h=y(null),l=y(),E=j({get:()=>typeof h.value=="string",set:()=>h.value=null});se(()=>r.command,n=>{if(!n)return;const{initial:e,override:t}=n;s.value={config:ae("command",e.config),options:de(e.options,(p,V)=>ae("command-option",e.options[V]))},l.value=me(t)},{immediate:true}),c.action("command.update",{disabled:()=>pe(X(l.value,["config","options"]),X(r.command.override,["config","options"])),action:()=>b("command/update",r.command.name,X(l.value,["config","options"]))});function D(n){const e=l.value.aliases[n];l.value.aliases={[n]:e,...l.value.aliases},b("command/aliases",r.command.name,l.value.aliases)}function G(n){r.command.initial.aliases[n]?l.value.aliases[n].filter=false:delete l.value.aliases[n],b("command/aliases",r.command.name,l.value.aliases)}function w(n){l.value.aliases[n]=r.command.initial.aliases[n],b("command/aliases",r.command.name,l.value.aliases)}function T(n){return[...n.args||[],...Object.entries(n.options||{}).map(([e,t])=>t===true?`--${e}`:`--${e}=${t}`)].join(" ")}async function J(){var n;await ne(),(n=S.value)==null||n.focus()}const P=j(()=>Object.values(i.value).flatMap(n=>n.override.aliases)),N=j(()=>!f.value||P.value[f.value]),U=y({});Ce(g,async n=>{n.trim()&&(U.value=await b("command/parse",r.command.name,g.value))},{debounce:500});async function K(){if(!N.value){if(g.value.trim()){const n=await b("command/parse",r.command.name,g.value);if(n.error)return;l.value.aliases[f.value]=n}else l.value.aliases[f.value]={};await b("command/aliases",r.command.name,l.value.aliases),E.value=false,g.value=""}}return(n,e)=>{const t=v("router-link"),p=v("el-button"),V=v("k-form"),H=v("el-input"),Q=v("el-dialog");return d(),x(q,null,[C("div",Ne,[L(R).config&&L(R).packages&&n.command.paths.length?(d(),$(t,{key:0,class:"el-button",to:"/plugins/"+n.command.paths[0].replace(/\./,"/")},{default:o(()=>[_("前往插件")]),_:1},8,["to"])):B("v-if",true),L(R).locales?(d(),$(t,{key:1,class:"el-button",to:"/locales/commands/"+n.command.name.replace(/\./,"/")},{default:o(()=>[_("前往本地化")]),_:1},8,["to"])):B("v-if",true)]),C("div",Ue,[C("h2",Ke,[_(" 别名设置 "),m(p,{class:"float-right mr-4",onClick:e[0]||(e[0]=u=>(f.value=h.value="",g.value=""))},{default:o(()=>[_("添加")]),_:1})]),C("table",null,[(d(true),x(q,null,Y(Object.entries(l.value.aliases),([u,k],M)=>(d(),x("tr",{key:u},[C("td",Be,[C("span",{class:F(["alias-name",{disabled:k.filter===false}])},z(u),3),_(" "+z(T(k)?`(${T(k)})`:""),1)]),C("td",Te,[M>0?(d(),$(p,{key:0,disabled:k.filter===false,onClick:A=>D(u)},{default:o(()=>[_(z(M>0?"设为默认":"显示名称"),1)]),_:2},1032,["disabled","onClick"])):B("v-if",true),k.filter!==false?(d(),$(p,{key:1,onClick:A=>G(u)},{default:o(()=>[_(z(n.command.initial.aliases[u]?"禁用":"删除"),1)]),_:2},1032,["onClick"])):(d(),$(p,{key:2,onClick:A=>w(u)},{default:o(()=>[_("恢复")]),_:2},1032,["onClick"]))])]))),128))])]),m(V,{schema:s.value.config,initial:n.command.override.config,modelValue:l.value.config,"onUpdate:modelValue":e[1]||(e[1]=u=>l.value.config=u)},{title:o(()=>[_("指令设置")]),_:1},8,["schema","initial","modelValue"]),(d(true),x(q,null,Y(n.command.initial.options,(u,k)=>(d(),$(V,{key:k,schema:s.value.options[k],initial:n.command.override.options[k],modelValue:l.value.options[k],"onUpdate:modelValue":M=>l.value.options[k]=M},{title:o(()=>[_("选项："+z(u.syntax),1)]),_:2},1032,["schema","initial","modelValue","onUpdate:modelValue"]))),128)),m(Q,{class:"command-alias-dialog","destroy-on-close":"",modelValue:E.value,"onUpdate:modelValue":e[5]||(e[5]=u=>E.value=u),title:h.value?"编辑别名":"添加别名",onOpen:J},{footer:o(()=>[m(p,{onClick:e[4]||(e[4]=u=>E.value=false)},{default:o(()=>[_("取消")]),_:1}),m(p,{type:"primary",disabled:N.value||U.value.error,onClick:K},{default:o(()=>[_("确定")]),_:1},8,["disabled"])]),default:o(()=>[C("div",null,[m(H,{ref_key:"inputEl",ref:S,class:F({invalid:N.value}),modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=u=>f.value=u),onKeydown:Z(ee(K,["stop","prevent"]),["enter"]),placeholder:"请输入别名"},null,8,["class","modelValue","onKeydown"])]),C("div",Ae,[m(H,{class:F({invalid:U.value.error}),modelValue:g.value,"onUpdate:modelValue":e[3]||(e[3]=u=>g.value=u),onKeydown:Z(ee(K,["stop","prevent"]),["enter"]),placeholder:"请输入参数 (可选)"},null,8,["class","modelValue","onKeydown"])])]),_:1},8,["modelValue","title"])],64)}}});const qe=W(Re,[["__scopeId","data-v-b2faa0f0"]]),Fe={class:"search"},Ie=C("div",null,"请在左侧选择指令",-1),We=I({__name:"commands",setup(a){const c=ve(),i=fe(),r=le(),s=te(),S=y(),f=y(""),g=y(null),h=y(""),l=y(null),E=j(()=>{const e={...s.value};for(const p in s.value)for(const V of s.value[p].children)delete e[V];function t(p){return p.sort().map(V=>{const H=s.value[V];return{...H,children:t(H.children)}})}return t(Object.keys(e))}),D=y(false);async function G(){var e;await ne(),(e=S.value)==null||e.focus()}se(h,e=>{g.value.filter(e)});const w=j({get(){const e=c.path.slice(10).replace(/\//g,".");return e in s.value?e:""},set(e){e in s.value||(e=""),i.replace("/commands/"+e.replace(/\./g,"/"))}});function T(e){const t=[];return e.name===w.value&&t.push("is-active"),t.join(" ")}function J(e,t){return t.name.toLowerCase().includes(h.value.toLowerCase())}function P(e){return!e.data.name.includes(".")}function N(e,t,p){return e.parent!==(p==="inner"?t:t.parent)}function U(e){w.value=e.name}function K(e,t,p,V){const H=p==="inner"?t:t.parent;b("command/teleport",e.data.name,H.data.name)}async function n(){await b("command/create",f.value),f.value=""}return _e(async()=>{const e=l.value.$el;await ne();const t=e.querySelector(".el-tree-node.is-active");t&&l.value.setScrollTop(t.offsetTop-(e.offsetHeight-t.offsetHeight)/2)}),r.action("command.create",{action:()=>D.value=true}),r.action("command.remove",{disabled:()=>{var e;return!((e=s.value[w.value])!=null&&e.create)},action:()=>b("command/remove",s.value[w.value].name)}),(e,t)=>{const p=v("k-icon"),V=v("el-input"),H=v("el-tree"),Q=v("el-scrollbar"),u=v("k-content"),k=v("k-empty"),M=v("el-button"),A=v("el-dialog"),re=v("k-layout");return d(),$(re,{menu:"command"},{header:o(()=>[_(" 指令管理"+z(w.value?" - "+w.value:""),1)]),left:o(()=>[m(Q,{class:"command-tree w-full h-full overflow-auto",ref_key:"root",ref:l},{default:o(()=>[C("div",Fe,[m(V,{modelValue:h.value,"onUpdate:modelValue":t[0]||(t[0]=O=>h.value=O)},{suffix:o(()=>[m(p,{name:"search"})]),_:1},8,["modelValue"])]),m(H,{ref_key:"treeEl",ref:g,draggable:true,data:E.value,props:{label:"name",class:T},"filter-node-method":J,"default-expand-all":true,"expand-on-click-node":false,"allow-drag":P,"allow-drop":N,onNodeClick:U,onNodeDrop:K},null,8,["data","props"])]),_:1},512)]),default:o(()=>[w.value?(d(),$(u,{key:0,class:"command-config"},{default:o(()=>[m(qe,{command:L(s)[w.value]},null,8,["command"])]),_:1})):(d(),$(k,{key:1},{default:o(()=>[Ie]),_:1})),m(A,{class:"command-dialog","destroy-on-close":"",modelValue:D.value,"onUpdate:modelValue":t[3]||(t[3]=O=>D.value=O),title:"添加指令",onOpen:G},{footer:o(()=>[m(M,{onClick:t[2]||(t[2]=O=>D.value=false)},{default:o(()=>[_("取消")]),_:1}),m(M,{type:"primary",disabled:!f.value,onClick:n},{default:o(()=>[_("确定")]),_:1},8,["disabled"])]),default:o(()=>[m(V,{ref_key:"inputEl",ref:S,class:F({invalid:!f.value}),modelValue:f.value,"onUpdate:modelValue":t[1]||(t[1]=O=>f.value=O),onKeydown:Z(ee(n,["stop","prevent"]),["enter"]),placeholder:"请输入名称"},null,8,["class","modelValue","onKeydown"])]),_:1},8,["modelValue"])]),_:1})}}});const Ge={key:0,class:"navigation flex flex-wrap gap-x-4 gap-y-2 my-8"},Je=I({__name:"locales",setup(a){const c=ce("locale:prefix");return(i,r)=>{const s=v("router-link");return L(c)&&L(c).startsWith("commands.")?(d(),x("div",Ge,[m(s,{class:"el-button",to:"/commands/"+L(c).slice(9).replace(/\./,"/")},{default:o(()=>[_("前往指令")]),_:1},8,["to"])])):B("v-if",true)}}}),Pe=C("p",null,"此插件提供了下列指令：",-1),Qe=I({__name:"settings",setup(a){const c=ce("manager.settings.current"),i=te(),r=j(()=>Object.values(i.value).filter(s=>s.paths.includes(c.value.path)).sort((s,S)=>s.name.localeCompare(S.name)));return(s,S)=>{const f=v("router-link"),g=v("k-comment");return r.value.length?(d(),$(g,{key:0,type:"success"},{default:o(()=>[Pe,C("ul",null,[(d(true),x(q,null,Y(r.value,h=>(d(),x("li",{key:h.name},[m(f,{to:"/commands/"+h.name.replace(/\./g,"/")},{default:o(()=>[_(z(h.name),1)]),_:2},1032,["to"])]))),128))])]),_:1})):B("v-if",true)}}});oe.register("activity:commands",we);oe.register("check",Me);oe.register("trash-can",je);const nn=a=>{a.page({path:"/commands/:name*",name:"指令管理",icon:"activity:commands",order:500,authority:4,component:We}),a.slot({type:"plugin-details",component:Qe,order:200}),a.slot({type:"locale-main",component:Je,order:1e3}),a.menu("command",[{id:".update",icon:"save",label:"保存更改"},{id:".remove",icon:"trash-can",label:"移除指令"},{id:".create",icon:"add",label:"创建指令"}])};export{nn as default};
